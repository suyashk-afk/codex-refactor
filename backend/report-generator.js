// Markdown Report Generator

/**
 * Generate markdown report for code analysis
 */
function generateAnalysisReport(analysis, filename) {
  let md = `# Code Analysis Report\n\n`;
  md += `**File:** ${filename}\n`;
  md += `**Date:** ${new Date().toLocaleDateString()}\n\n`;
  
  md += `## Quality Score: ${analysis.qualityScore}/100\n\n`;
  
  const status = analysis.summary?.healthStatus || 'unknown';
  const emoji = status === 'healthy' ? '‚úÖ' : status === 'needs_improvement' ? '‚ö†Ô∏è' : 'üî¥';
  md += `**Status:** ${emoji} ${status.replace('_', ' ').toUpperCase()}\n\n`;
  
  md += `## Summary\n\n`;
  md += `- **Functions:** ${analysis.summary?.totalFunctions || 0}\n`;
  md += `- **Average Length:** ${analysis.summary?.averageLength || 0} lines\n`;
  md += `- **Total Issues:** ${analysis.totalSmells || 0}\n\n`;
  
  if (analysis.totalSmells > 0) {
    md += `## Code Smells Detected\n\n`;
    for (const [type, count] of Object.entries(analysis.smellsByType || {})) {
      md += `- **${type.replace(/_/g, ' ')}:** ${count}\n`;
    }
    md += `\n`;
  }
  
  if (analysis.functions && analysis.functions.length > 0) {
    md += `## Function Details\n\n`;
    for (const fn of analysis.functions) {
      md += `### ${fn.name}\n\n`;
      md += `- **Length:** ${fn.length} lines\n`;
      md += `- **Nesting Depth:** ${fn.nesting}\n`;
      md += `- **Complexity:** ${fn.branchCount}\n\n`;
      
      if (fn.smells && fn.smells.length > 0) {
        md += `**Issues:**\n\n`;
        for (const smell of fn.smells) {
          md += `- **[${smell.severity.toUpperCase()}]** ${smell.type.replace(/_/g, ' ')}\n`;
          md += `  - ${smell.message}\n`;
          md += `  - üí° ${smell.suggestion}\n\n`;
        }
      } else {
        md += `‚úÖ No issues found\n\n`;
      }
    }
  }
  
  md += `---\n\n`;
  md += `*Generated by Refactor Codex*\n`;
  
  return md;
}

/**
 * Generate markdown report for repository analysis
 */
function generateRepositoryReport(repoAnalysis) {
  let md = `# Repository Analysis Report\n\n`;
  md += `**Repository:** ${repoAnalysis.repository.owner}/${repoAnalysis.repository.repo}\n`;
  md += `**Date:** ${new Date().toLocaleDateString()}\n`;
  md += `**Files Analyzed:** ${repoAnalysis.repository.analyzedFiles}/${repoAnalysis.repository.totalFiles}\n\n`;
  
  md += `## Overall Health\n\n`;
  md += `- **Average Quality Score:** ${repoAnalysis.summary.averageQualityScore}/100\n`;
  md += `- **Total Code Smells:** ${repoAnalysis.summary.totalSmells}\n`;
  md += `- **Total Functions:** ${repoAnalysis.summary.totalFunctions}\n`;
  md += `- **Technical Debt:** ${repoAnalysis.summary.technicalDebtHours} hours\n`;
  
  const status = repoAnalysis.summary.healthStatus;
  const emoji = status === 'healthy' ? '‚úÖ' : status === 'needs_improvement' ? '‚ö†Ô∏è' : 'üî¥';
  md += `- **Status:** ${emoji} ${status.replace('_', ' ').toUpperCase()}\n\n`;
  
  md += `## Files Needing Attention\n\n`;
  md += `| Rank | File | Score | Smells |\n`;
  md += `|------|------|-------|--------|\n`;
  
  for (let i = 0; i < Math.min(10, repoAnalysis.worstFiles.length); i++) {
    const file = repoAnalysis.worstFiles[i];
    md += `| ${i + 1} | ${file.path} | ${file.qualityScore} | ${file.totalSmells} |\n`;
  }
  
  md += `\n---\n\n`;
  md += `*Generated by Refactor Codex*\n`;
  
  return md;
}

/**
 * Generate markdown report for time machine analysis
 */
function generateTimelineReport(historyData) {
  let md = `# Code Quality Timeline Report\n\n`;
  md += `**Repository:** ${historyData.owner}/${historyData.repo}\n`;
  md += `**File:** ${historyData.filePath}\n`;
  md += `**Date:** ${new Date().toLocaleDateString()}\n`;
  md += `**Commits Analyzed:** ${historyData.timeline.length}\n\n`;
  
  if (historyData.insights) {
    const insights = historyData.insights;
    
    md += `## Overall Trend\n\n`;
    const trendEmoji = insights.overallTrend === 'improving' ? 'üìà' : 
                       insights.overallTrend === 'declining' ? 'üìâ' : '‚û°Ô∏è';
    md += `${trendEmoji} **${insights.overallTrend.toUpperCase()}** (${insights.overallChange > 0 ? '+' : ''}${insights.overallChange} points)\n\n`;
    
    md += `## Key Metrics\n\n`;
    md += `- **Average Quality Score:** ${insights.avgScore}/100\n`;
    md += `- **Time Period:** ${new Date(insights.timespan.start).toLocaleDateString()} to ${new Date(insights.timespan.end).toLocaleDateString()}\n\n`;
    
    if (insights.biggestImprovement) {
      md += `## Best Commit üåü\n\n`;
      md += `- **Commit:** ${insights.biggestImprovement.commit.sha}\n`;
      md += `- **Improvement:** +${insights.biggestImprovement.gain} points\n`;
      md += `- **Message:** ${insights.biggestImprovement.commit.message}\n\n`;
    }
    
    if (insights.biggestRegression) {
      md += `## Worst Commit üî•\n\n`;
      md += `- **Commit:** ${insights.biggestRegression.commit.sha}\n`;
      md += `- **Regression:** -${insights.biggestRegression.drop} points\n`;
      md += `- **Message:** ${insights.biggestRegression.commit.message}\n\n`;
    }
    
    if (insights.regressions && insights.regressions.length > 0) {
      md += `## Quality Regressions ‚ö†Ô∏è\n\n`;
      md += `Found ${insights.regressions.length} commit(s) that significantly decreased quality:\n\n`;
      for (const reg of insights.regressions) {
        md += `- **${reg.commit}**: "${reg.message}" (-${reg.drop} points)\n`;
      }
      md += `\n`;
    }
  }
  
  md += `## Commit History\n\n`;
  md += `| Commit | Date | Score | Smells | Change |\n`;
  md += `|--------|------|-------|--------|--------|\n`;
  
  for (let i = 0; i < historyData.timeline.length; i++) {
    const commit = historyData.timeline[i];
    const prevScore = i < historyData.timeline.length - 1 ? historyData.timeline[i + 1].score : commit.score;
    const change = commit.score - prevScore;
    const changeStr = change === 0 ? '-' : `${change > 0 ? '+' : ''}${change}`;
    
    md += `| ${commit.sha} | ${new Date(commit.date).toLocaleDateString()} | ${commit.score} | ${commit.smells} | ${changeStr} |\n`;
  }
  
  md += `\n---\n\n`;
  md += `*Generated by Refactor Codex Time Machine*\n`;
  
  return md;
}

module.exports = {
  generateAnalysisReport,
  generateRepositoryReport,
  generateTimelineReport
};
